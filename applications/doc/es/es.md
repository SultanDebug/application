## es名词
#### 索引-index
- 索引可以被认为是文档的优化集合，每个文档都是字段的集合，字段是包含数据的键值对。
- 默认情况下，Elasticsearch 索引每个字段中的所有数据，并且每个索引字段都有一个专用的优化数据结构。
- 例如，文本字段存储在倒排索引中，而数字和地理字段存储在 BKD 树中。
- 使用每个字段的数据结构来组装和返回搜索结果的能力是 Elasticsearch 如此快速的原因

#### 映射-mapping
- 动态映射，Elasticsearch 会自动检测新字段并将其添加到索引中
- 会检测并将布尔值、浮点和整数值、日期和字符串映射到适当的 Elasticsearch 数据类型
- 定义规则来控制动态映射并显式定义映射以完全控制字段的存储和索引方式

#### 查询-query
- 结构化查询（精确）、全文查询（全文匹配，相关性排序）和复杂查询（关键指标、模式和趋势）

#### 分片-shards
- 每个分片节点自有索引，自包含索引管理自己分片文档数据，

#### 副本-primaries / replicas
- 分片副本，数据的冗余副本以防止硬件故障并增加处理读取请求（如搜索或检索文档）的容量
- 索引主分片的数量在创建索引时是固定的，副本分片可修改

> 思考：分片大小和为索引配置的主分片数量，数量多则索引维护开销大且召回请求多，分片大小越大则平衡集群是移动分片开销大

## 集群灾备
- 跨集群复制-ccr

> 索引，分片，段，段归并，文件缓存，刷盘，translog（灾备）
> 写请求（记translog）buffer（refresh）文件缓存（flush，删translog）刷盘
> refresh：默认1秒，也就是1秒一个segment（段）
> flush：默认30秒，512兆刷盘，还可以自定义数据量刷盘
> translog一致性：5秒或请求结束前刷盘，不需要一致性的时候可异步刷盘

> 段合并：合并小段不影响新段生成，合并完删除小段，合并过程既耗IO又耗CPU，所以有线程限速机制
> 合并段条件：小于2兆，一次10-30个，大于5G不参与归并
> forcemerge：热索引谨慎使用，开销太大
> 【可取消所有副本，只用主分片归并，减少重复归并】

> routing：哈希取模，对主分片数取模，主分片数不可修改，修改导致数据不可索引
> 数据写入可配置主分片确认和半数分片确认和所有分片确认，参数自定义，计算得到三种确认模式

> 数据均衡
> 分片分配

## 查询
- 相似算法：
> TF-IDF term freq - inverse doc freq 词频和逆向文档频率
> 词频就是token（term）出现次数，idf为token在全局的罕见程度，一个是局部词频，一个是全局词频罕见度，相乘得到相关性得分
> 公式  tf*log（n/df）
> BM25 基于TF-IDF，默认


- 倒排索引
> 所有文档content域拆分成单独词条（token），创建一个不重复词条列表，标注每个词条出现的文档。
> 倒排索引列出了出现在任何文档中的每个唯一单词，并标识了每个单词出现的所有文档。

- 这时候按词条匹配，缺陷
> 区分大小写的相同词条 a/A 认为是两个词
> 相同词根的词 dog/dogs 认为是两个词
> 同义词 认为是两个词

- 实际查询
> a.索引生成的时候做标准化
> b.查询索引的时候对查询词条也要标准化

## API
- 只返回部分字段
```html
get /index?_source=f1,f.
```

- mget请求体用换行符分割请求体，不使用json，节省内存、解析、反序列化等操作

- timeout只做业务超时，返回超时前收集的数据，后台还是会运行知道完成或异常

- 数据更新会更新索引，主分片到副本分片，由于异步不保证顺序，可能导致数据错误

- _all字段是文档所有值组成的全文，用于全文搜索，可禁用